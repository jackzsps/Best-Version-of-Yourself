# Resolve React Native's podspec
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

# âš ï¸ é–å®š iOS å¹³å°ç‰ˆæœ¬
platform :ios, '16.1'
prepare_react_native_project!

# è§£æ±º Firebase Swift ä¾è³´
use_modular_headers!
use_frameworks! :linkage => :static

ENV['RCT_NEW_ARCH_ENABLED'] = '1'

target 'BestVersionOfYourself' do
  config = use_native_modules!

  # 1. é—œé–‰æ¨¡çµ„ç”Ÿæˆ
  pod 'gRPC-Core', :modular_headers => false
  pod 'gRPC-C++', :modular_headers => false
  pod 'BoringSSL-GRPC', :modular_headers => false

  # ğŸ’¡ [å¤§å¸«ä¿®æ­£é»] æŒ‡å®š podspec è·¯å¾‘
  pod 'RCT-Folly', :podspec => '../node_modules/react-native/third-party-podspecs/RCT-Folly.podspec', :modular_headers => false

  use_react_native!(
    :path => config[:reactNativePath],
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    # æ¨™æº– RN å¾Œè™•ç†
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    # ---------------------------------------------------------
    # PART 1: ä¿®æ”¹ Pods (ç¬¬ä¸‰æ–¹å¥—ä»¶) çš„è¨­å®š
    # ---------------------------------------------------------
      installer.pods_project.targets.each do |target|
      puts "  Processing Pod target: #{target.name}"
      target.build_configurations.each do |config|
        # å¼·åˆ¶è¦†å¯« Deployment Target (è§£æ±º RNGoogleSignin 10.0 å•é¡Œ)
        # ç‰¹åˆ¥é‡å° RNGoogleSignin ç¢ºä¿å®ƒè¢«æ­£ç¢ºè¨­å®š
        if target.name == 'RNGoogleSignin'
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.1'
          # å¼·åˆ¶é–‹å•Ÿ Aligned Allocation æ”¯æ´
          cflags = config.build_settings['OTHER_CPLUSPLUSFLAGS'] 
          cflags = [cflags] if cflags.is_a?(String)
          cflags ||= ['$(inherited)']
          cflags << '-faligned-allocation'
          config.build_settings['OTHER_CPLUSPLUSFLAGS'] = cflags
        end
        # å…¨åŸŸå¼·åˆ¶è¨­å®š (ä¿éšªèµ·è¦‹)
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.1'
        
        config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
        config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++20'

        # ğŸ›  [ä¿®å¾©é‡é» 1] å®‰å…¨è™•ç† GCC_PREPROCESSOR_DEFINITIONS
        # å…ˆè®€å–ï¼Œå¦‚æœæ˜¯å­—ä¸²å°±è½‰æˆé™£åˆ—ï¼Œå¦‚æœæ˜¯ nil å°±çµ¦é è¨­å€¼
        current_defs = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
        current_defs = [current_defs] if current_defs.is_a?(String)
        current_defs ||= ['$(inherited)']
        
        # åŠ å…¥ Folly Flags ä¸¦å»é™¤é‡è¤‡ (.uniq æ˜¯è§£æ±º NDEBUG redefined çš„é—œéµ)
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = (current_defs + ['FOLLY_NO_COROUTINES=1', 'FOLLY_CFG_NO_COROUTINES=1']).uniq

        # ğŸ›  [ä¿®å¾©é‡é» 2] å®‰å…¨è™•ç† OTHER_CPLUSPLUSFLAGS
        # é€™èƒ½è§£æ±º "requires whitespace" å•é¡Œï¼Œå› ç‚ºé™£åˆ—æœƒè‡ªå‹•è¢«æ­£ç¢ºåˆ†éš”
        current_cpp = config.build_settings['OTHER_CPLUSPLUSFLAGS']
        current_cpp = [current_cpp] if current_cpp.is_a?(String)
        current_cpp ||= ['$(inherited)']
        
        # å…ˆæº–å‚™å¥½è¦åŠ çš„ Flags
        extra_cpp_flags = ['-DFOLLY_NO_COROUTINES=1', '-DFOLLY_CFG_NO_COROUTINES=1']
        
        # é‡å° RCT-Folly çš„ç‰¹æ®Šè™•ç†
        if target.name == "RCT-Folly"
          config.build_settings['CLANG_ENABLE_MODULES'] = 'NO'
          extra_cpp_flags << '-faligned-allocation'
        end

        # åˆä½µä¸¦å»é‡
        config.build_settings['OTHER_CPLUSPLUSFLAGS'] = (current_cpp + extra_cpp_flags).uniq

        # [NitroModules] ä¿®æ­£æ¨™é ­æª”è·¯å¾‘
        if target.name == "NitroModules"
          header_paths = config.build_settings['HEADER_SEARCH_PATHS']
          header_paths = [header_paths] if header_paths.is_a?(String)
          header_paths ||= ['$(inherited)']
          header_paths << '"${PODS_CONFIGURATION_BUILD_DIR}/React-Codegen/React_Codegen.framework/Headers"'
          config.build_settings['HEADER_SEARCH_PATHS'] = header_paths
        end
      end
    end

    # ---------------------------------------------------------
    # PART 2: è‡ªå‹•ä¿®æ”¹ä¸» App è¨­å®š
    # ---------------------------------------------------------
    project_path = File.join(__dir__, 'BestVersionOfYourself.xcodeproj')
    project = Xcodeproj::Project.open(project_path)
    
    project.targets.each do |target|
      if target.name == 'BestVersionOfYourself'
        puts "  ğŸ‘‰ Updating User Project target: #{target.name}..."
        target.build_configurations.each do |config|
          
          # 1. ä¸»å°ˆæ¡ˆ Preprocessor Definitions (å®‰å…¨å»é‡ç‰ˆ)
          current_defs = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
          current_defs = [current_defs] if current_defs.is_a?(String)
          current_defs ||= ['$(inherited)']
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = (current_defs + ['FOLLY_NO_COROUTINES=1', 'FOLLY_CFG_NO_COROUTINES=1']).uniq

          # 2. ä¸»å°ˆæ¡ˆ C++ Flags (å®‰å…¨å»é‡ç‰ˆ)
          current_cpp = config.build_settings['OTHER_CPLUSPLUSFLAGS']
          current_cpp = [current_cpp] if current_cpp.is_a?(String)
          current_cpp ||= ['$(inherited)']
          config.build_settings['OTHER_CPLUSPLUSFLAGS'] = (current_cpp + ['-DFOLLY_NO_COROUTINES=1', '-DFOLLY_CFG_NO_COROUTINES=1']).uniq
          
          # 3. [é—œéµä¿®å¾©] å¼·åˆ¶åŠ å…¥ React Native Header Search Paths
          # é€™æ˜¯ç‚ºäº†è§£æ±º use_frameworks! å°è‡´æ‰¾ä¸åˆ° RCTAppDelegate.h çš„å•é¡Œ
          header_search_paths = config.build_settings['HEADER_SEARCH_PATHS']
          header_search_paths = [header_search_paths] if header_search_paths.is_a?(String)
          header_search_paths ||= ['$(inherited)']
          header_search_paths << '$(SRCROOT)/../node_modules/react-native/Libraries/AppDelegate'
          config.build_settings['HEADER_SEARCH_PATHS'] = header_search_paths
          
        end
      end
    end
    project.save
  end
end