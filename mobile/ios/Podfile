# Resolve React Native's podspec
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

# âš ï¸ é–å®š iOS å¹³å°ç‰ˆæœ¬
platform :ios, '16.1'
prepare_react_native_project!

# è§£æ±º Firebase Swift ä¾è³´
use_modular_headers!
use_frameworks! :linkage => :static

ENV['RCT_NEW_ARCH_ENABLED'] = '1'

target 'BestVersionOfYourself' do
  config = use_native_modules!

  # 1. é—œé–‰æ¨¡çµ„ç”Ÿæˆ
  pod 'gRPC-Core', :modular_headers => false
  pod 'gRPC-C++', :modular_headers => false
  pod 'BoringSSL-GRPC', :modular_headers => false

  # ğŸ’¡ [å¤§å¸«ä¿®æ­£é»] æŒ‡å®š podspec è·¯å¾‘ï¼Œè§£æ±º "multiple dependencies" éŒ¯èª¤
  pod 'RCT-Folly', :podspec => '../node_modules/react-native/third-party-podspecs/RCT-Folly.podspec', :modular_headers => false

  use_react_native!(
    :path => config[:reactNativePath],
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    # æ¨™æº– RN å¾Œè™•ç†
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    # ---------------------------------------------------------
    # PART 1: ä¿®æ”¹ Pods (ç¬¬ä¸‰æ–¹å¥—ä»¶) çš„è¨­å®š
    # ---------------------------------------------------------
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.1'
        config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

        # ğŸ† [å¼·åˆ¶] å…¨å±€çµ±ä¸€ä½¿ç”¨ C++20 æ¨™æº–
        config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++20'

        # [ä¿®å¾© Folly] ç¦ç”¨å”ç¨‹ (Coroutines)
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'FOLLY_NO_COROUTINES=1'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'FOLLY_CFG_NO_COROUTINES=1'

        config.build_settings['OTHER_CPLUSPLUSFLAGS'] ||= ['$(inherited)']
        config.build_settings['OTHER_CPLUSPLUSFLAGS'] << '-DFOLLY_NO_COROUTINES=1'
        config.build_settings['OTHER_CPLUSPLUSFLAGS'] << '-DFOLLY_CFG_NO_COROUTINES=1'

        # ğŸ† [é—œéµä¿®å¾©] é‡å° RCT-Folly çš„ç‰¹æ®Šè™•ç† (è§£æ±º New.h å ±éŒ¯)
        if target.name == "RCT-Folly"
          # 1. é—œé–‰ Clang Modules (é›™é‡ä¿éšªï¼Œé…åˆä¸Šé¢çš„ :modular_headers => false)
          config.build_settings['CLANG_ENABLE_MODULES'] = 'NO'
          # 2. å¼·åˆ¶é–‹å•Ÿå°é½Šåˆ†é…æ”¯æ´
          config.build_settings['OTHER_CPLUSPLUSFLAGS'] << ' -faligned-allocation'
        end

        # [NitroModules] ä¿®æ­£æ¨™é ­æª”è·¯å¾‘
        if target.name == "NitroModules"
          config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
          config.build_settings['HEADER_SEARCH_PATHS'] << '"${PODS_CONFIGURATION_BUILD_DIR}/React-Codegen/React_Codegen.framework/Headers"'
        end
      end
    end

    # ---------------------------------------------------------
    # PART 2: è‡ªå‹•ä¿®æ”¹ä¸» App è¨­å®š
    # ---------------------------------------------------------
    project_path = File.join(__dir__, 'BestVersionOfYourself.xcodeproj')
    project = Xcodeproj::Project.open(project_path)
    
    project.targets.each do |target|
      if target.name == 'BestVersionOfYourself'
        puts "  ğŸ‘‰ Updating User Project target: #{target.name}..."
        target.build_configurations.each do |config|
          # æ³¨å…¥ Preprocessor Macro
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
          ['FOLLY_NO_COROUTINES=1', 'FOLLY_CFG_NO_COROUTINES=1'].each do |flag|
            unless config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'].include?(flag)
               config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << flag
            end
          end
          # æ³¨å…¥ C++ Flags
          config.build_settings['OTHER_CPLUSPLUSFLAGS'] ||= ['$(inherited)']
          ['-DFOLLY_NO_COROUTINES=1', '-DFOLLY_CFG_NO_COROUTINES=1'].each do |flag|
             unless config.build_settings['OTHER_CPLUSPLUSFLAGS'].include?(flag)
                config.build_settings['OTHER_CPLUSPLUSFLAGS'] << flag
             end
          end
        end
      end
    end
    project.save
  end
end