# Resolve React Native's podspec
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

# âš ï¸ é–å®š iOS å¹³å°ç‰ˆæœ¬ (React Native 0.83+ å»ºè­° 16.0+)
platform :ios, '16.1'
prepare_react_native_project!

# è§£æ±º Firebase Swift ä¾è³´
use_modular_headers!

# [Fix for Firebase] å¼·åˆ¶ä½¿ç”¨éœæ…‹ Framework
use_frameworks! :linkage => :static

# New Architecture is enabled by default in 0.83, but we can be explicit
ENV['RCT_NEW_ARCH_ENABLED'] = '1'

target 'BestVersionOfYourself' do
  config = use_native_modules!

  # Manually add NitroModules
  pod 'NitroModules', :path => '../node_modules/react-native-nitro-modules'

  # 1. é—œé–‰æ¨¡çµ„ç”Ÿæˆ (è§£æ±º gRPC è¡çª)
  pod 'gRPC-Core', :modular_headers => false
  pod 'gRPC-C++', :modular_headers => false
  pod 'BoringSSL-GRPC', :modular_headers => false

  use_react_native!(
    :path => config[:reactNativePath],
    # Note: app_path is optional in newer versions, but good to keep if unsure
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    # react_native_post_install handles most things now
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    # =========================================================
    # ğŸ›¡ï¸ é‡å° Xcode 16 / iOS 16+ çš„é˜²ç¦¦æ€§è¨­å®š
    # =========================================================
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # [Fix 3] å¼·åˆ¶æå‡éƒ¨ç½²ç‰ˆæœ¬
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.1'
        
        # [Fix 4] å…è¨±éæ¨¡çµ„åŒ–å¼•ç”¨
        config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

        # =========================================================
        # ğŸ† [é—œéµä¿®å¾©] Reanimated v4 + Folly C++20 å”ç¨‹è¡çª
        # =========================================================
        if target.name == "RNReanimated"
          # ç¢ºä¿ GCC_PREPROCESSOR_DEFINITIONS æ˜¯å€‹é™£åˆ—ï¼Œé¿å… nil éŒ¯èª¤
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
          
          # å¼·åˆ¶æ³¨å…¥ FOLLY_NO_COROUTINES=1
          # é€™æœƒå‘Šè¨´ç·¨è­¯å™¨ï¼šã€Œé›–ç„¶ç”¨ C++20ï¼Œä½†è«‹ä¸è¦é–‹å•Ÿ Folly çš„å”ç¨‹åŠŸèƒ½ã€
          # å¾è€Œé¿é–‹æ‰¾ä¸åˆ° folly/coro/Coroutine.h çš„éŒ¯èª¤
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'FOLLY_NO_COROUTINES=1'
        end

        # =========================================================
        # ğŸ† [é—œéµä¿®å¾©] NitroModules header search paths
        # =========================================================
        if target.name == "NitroModules"
          config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
          config.build_settings['HEADER_SEARCH_PATHS'] << '"${PODS_CONFIGURATION_BUILD_DIR}/React-Codegen/React_Codegen.framework/Headers"'
        end

      end
    end
    
  end
end