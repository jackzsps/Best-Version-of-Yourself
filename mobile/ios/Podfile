require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

# âš ï¸ é–å®š iOS å¹³å°ç‰ˆæœ¬
platform :ios, '15.1'
prepare_react_native_project!

# è§£æ±º Firebase Swift ä¾è³´ (æ¨¡çµ„åŒ–æ¨™é ­æª”)
use_modular_headers!

# å¼·åˆ¶å•Ÿç”¨ New Architecture
ENV['RCT_NEW_ARCH_ENABLED'] = '1'

# ğŸ”´ [å…³é”®ä¿®æ­£] å¼·åˆ¶å•Ÿç”¨ Static Frameworks
# é€™æ˜¯è§£æ±º 'FirebaseAuth/FirebaseAuth-Swift.h file not found' çš„å”¯ä¸€è§£æ³•
use_frameworks! :linkage => :static

target 'BestVersionOfYourself' do
  config = use_native_modules!

  # 1. é—œé–‰ gRPC çš„æ¨¡çµ„ç”Ÿæˆ
  pod 'gRPC-Core', :modular_headers => false
  pod 'gRPC-C++', :modular_headers => false
  pod 'BoringSSL-GRPC', :modular_headers => false

  use_react_native!(
    :path => config[:reactNativePath],
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    # =========================================================
    # ğŸ›¡ï¸ é‡å° Xcode 26.2 / SDK 26 çš„é˜²ç¦¦æ€§è¨­å®š
    # =========================================================
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # [Fix 1] å¼·åˆ¶é—œé–‰éœæ…‹åˆ†æ
        config.build_settings['RUN_CLANG_STATIC_ANALYZER'] = 'NO'
        
        # [Fix 2] é—œé–‰å°‡è­¦å‘Šè¦–ç‚ºéŒ¯èª¤
        config.build_settings['GCC_TREAT_WARNINGS_AS_ERRORS'] = 'NO'
        
        # [Fix 3] å¼·åˆ¶æå‡éƒ¨ç½²ç‰ˆæœ¬
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.1'
        
        # [Fix 4] å…è¨±éæ¨¡çµ„åŒ–å¼•ç”¨
        config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'

        # [Fix 5] è§£æ±º C++ æ¨™æº–åº«ç›¸å®¹æ€§
        defs = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
        defs = defs.is_a?(String) ? [defs] : (defs || [])
        defs << '$(inherited)' unless defs.include?('$(inherited)')
        defs << '_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_BINARY_FUNCTION'
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = defs

        # [Fix 6] ç§»é™¤ Module Map
        if target.name.include?('gRPC') || target.name.include?('BoringSSL')
          config.build_settings.delete('MODULEMAP_FILE')
          config.build_settings['CLANG_ENABLE_MODULES'] = 'NO'
        end
      end
    end

    # ---------------------------------------------------------
    # ğŸ©¹ [Patch 1] ç‰©ç†ä¿®å¾© gRPC-Core (fdopen éŒ¯èª¤)
    # ---------------------------------------------------------
    puts "Applying gRPC-Core zlib patch..."
    Dir.glob("Pods/gRPC-Core/third_party/zlib/**/*.h").each do |file|
      begin
        content = File.read(file)
        if content.match(/#\s*define\s+fdopen\(fd,mode\)\s+NULL/)
          puts "  - Patching broken fdopen macro in #{file}"
          new_content = content.gsub(/#\s*define\s+fdopen\(fd,mode\)\s+NULL/, "/* patched: fdopen */")
          File.open(file, "w") { |f| f.write(new_content) }
        end
      rescue => e
        puts "  - Failed to patch #{file}: #{e.message}"
      end
    end

    # ---------------------------------------------------------
    # ğŸ©¹ [Patch 2] ç‰©ç†ä¿®å¾© glog (syscall deprecated éŒ¯èª¤)
    # ---------------------------------------------------------
    puts "Applying glog patch..."
    Dir.glob("Pods/glog/src/**/*.cc").each do |file|
      content = File.read(file)
      if content.include?("syscall(SYS_gettid)")
        puts "  - Patching syscall(SYS_gettid) in #{file}"
        new_content = content.gsub(/return\s+static_cast<int>\(syscall\(SYS_gettid\)\);/, "return 0; // patched")
        File.open(file, "w") { |f| f.write(new_content) }
      end
    end
  end
end